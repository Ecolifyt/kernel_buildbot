name: Build RisignOSS
permissions:
  actions: write
  contents: write
  statuses: write
  
on:
  workflow_dispatch:
  
jobs:
  Build-rom:
    name: "🐎 Build Rom"
    runs-on: fast
      
    steps:
      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16

      - name: ⏰ Set builddate
        id: generate-builddate
        run: echo "BUILDDATE=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        
      # This action checks-out your CONFIGSitory under $GITHUB_WORKSPACE, so your workflow can access it.
      - name: 😄 Checkout
        uses: actions/checkout@v4
          
      # Install prerequisites for Ubuntu
      - name: ⭐ Install prerequisites
        run: |
          sudo apt update && sudo apt -y upgeade
          DEBIAN_FRONTEND=noninteractive sudo apt install -y \
          bc bison lib32ncurses5-dev libncurses5 libncurses5-dev build-essential \
          openvpn openvpn-systemd-resolved ccache curl flex g++-multilib gcc-multilib git git-lfs gnupg gperf \
          imagemagick protobuf-compiler python3-protobuf lib32readline-dev lib32z1-dev libdw-dev libelf-dev lz4 \
          libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc \
          zip zlib1g-dev

      - name: Configure the 'repo' environment
        run: |
          # Check if repo is already installed
          if ! command -v repo >/dev/null 2>&1; then
            echo "Repo not found. Installing now..."
            # Create bin directory if it doesn't exist
            mkdir -p ~/bin
            # Download repo script
            curl https://storage.googleapis.com/git-repo-downloads/repo >> ~/bin/repo
            # Make repo script executable
            chmod a+x ~/bin/repo
            # Create symbolic link to /usr/bin/repo
            sudo ln -sf "/home/$(whoami)/bin/repo" "/usr/bin/repo"
            echo "Repo installation complete."
          else
            echo "Repo already installed."
          fi
        continue-on-error: true
          
      - name: 🌟 checkout aosp build system
        run: |
          repo init -u https://github.com/RisingOS-Revived/android -b qpr2 --git-lfs --depth=1
          git clone --depth=1 https://github.com/Ecolifyt/local_manifests .repo/local_manifests
          find .repo -name '*.lock' -delete
          repo sync -c -j32 --force-sync --no-clone-bundle --no-tags --prune
     
      - name: 💫 Build Rom
        run: |
          bash build.sh
      
      - name: "💾 Upload RisignOSS build files => (${{ env.BUILD_DATE }})"
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          path: |
            rom/out/target/product/cheetah/*.zip
            rom/out/target/product/cheetah/*.img

      - name: 🧧 Create GitHub Release => (${{ env.BUILD_DATE }})
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: Ecolifyt
          REPO_NAME: kernel_buildbot
          RELEASE_NAME: "RisignOs"
          RELEASE_NOTES: |
            ## Release Notes for v${{ env.BUILD_DATE }}.${{ github.run_number }}
            ### Features:
            - [+] First build
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.BUILD_DATE }}.${{ github.run_number }}
          files: |
             out/target/product/cheetah/*.zip
             out/target/product/cheetah/*.img
          generate_release_notes: true
