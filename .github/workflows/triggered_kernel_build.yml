name: triggered kernel build
on:
    push:
        branches:
            - gki
            - gki_ksu
            - gki_ksu_susfs
            - sauce
    workflow_dispatch:
jobs:
    bluejay_gki:
        runs-on: ubuntu-22.04
        steps:
            - name: checkout scripts
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            
            - name: install packages
              run: |
                ./pkginstall

            - name: init credentials
              run: |   
                cd ~      
                git config --global user.name "[kernel buildbot] vy"
                git config --global user.email "vy@buildbot.tvyiutnhisokewt"
            
            - name: checkout aosp kernel build system
              run: |
                cp buildscript ~ 
                cd ~
                mkdir kernel
                cp buildscript kernel
                cd kernel
                repo init -u https://android.googlesource.com/kernel/manifest.git -b android-gs-bluejay-6.1-android15-qpr2-beta --depth 1
                repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync
            
            - name: checkout android14-6.1-lts
              run: |
                cd ~/kernel
                rm -rf aosp/
                git clone https://android.googlesource.com/kernel/common -b android14-6.1-lts --depth=1 aosp
  
            - name: build gki
              run: |
                cd ~
                BUILD_TYPE=gki ./kernel/buildscript bluejay

            - name: upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                 name: bluejay_gki
                 path: |
                    ~/kernel/out/bluejay/dist/*

            - name: upload to branch
              run: |
                git checkout prebuilt_bluejay_gki
                rm -rf *
                cp -rf ~/kernel/out/bluejay/dist .
                git add -A
                git commit -m '[kernel buildbot] tvy: upload prebuilt to branch' --signoff
                git push -u origin prebuilt_bluejay_gki

    bluejay_gki-ksunext:
        runs-on: ubuntu-22.04
        steps:
            - name: checkout scripts
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            
            - name: install packages
              run: |
                ./pkginstall

            - name: init credentials
              run: |   
                cd ~      
                git config --global user.name "[kernel buildbot] vy"
                git config --global user.email "vy@buildbot.tvyiutnhisokewt"
            
            - name: checkout aosp kernel build system
              run: |
                cp buildscript ~ 
                cd ~
                mkdir kernel
                cp buildscript kernel
                cd kernel
                repo init -u https://android.googlesource.com/kernel/manifest.git -b android-gs-bluejay-6.1-android15-qpr2-beta --depth 1
                repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

            - name: checkout android14-6.1-lts
              run: |
                cd ~/kernel
                rm -rf aosp/
                git clone https://android.googlesource.com/kernel/common -b android14-6.1-lts --depth=1 aosp
            
            - name: clone wild kernel patches + susfs4ksu
              run: |
                git clone https://github.com/WildPlusKernel/kernel_patches.git
                git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1
                mv kernel_patches ~/kernel
                mv susfs4ksu ~/kernel

            - name: patch kernel ksunext susfs
              run: |
                cd ~
                cd kernel/aosp
                curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s next
                rm android/abi_gki_protected_exports_*
                cd ~/kernel
                cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ./aosp/
                cp susfs4ksu/kernel_patches/fs/* ./aosp/fs/
                cp susfs4ksu/kernel_patches/include/linux/* ./aosp/include/linux/
                cp kernel_patches/next/0001-kernel-patch-susfs-v1.5.5-to-KernelSU-Next-v1.0.5.patch ./aosp/KernelSU-Next
                cd ~/kernel/aosp/KernelSU-Next
                patch -p1 --forward < 0001-kernel-patch-susfs-v1.5.5-to-KernelSU-Next-v1.0.5.patch || true
                cd ..
                patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch || true

            - name: bluejay 90hz patch
              run: |
                cd ~
                rm -rf kernel/private/devices/google/bluejay/*
                git clone https://github.com/tvyiutnhisokewt/private_devices_google_bluejay
                cp -r private_devices_google_bluejay/* kernel/private/devices/google/bluejay/

            - name: build gki with kernelsu-next
              run: |
                cd ~
                BUILD_TYPE=gki-ksunext ./kernel/buildscript bluejay

            - name: upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                 name: bluejay_gki-ksunext
                 path: |
                    ~/kernel/out/bluejay/dist/*

            - name: upload to branch
              run: |
                git checkout prebuilt_bluejay_gki-ksunext
                rm -rf *
                cp -rf ~/kernel/out/bluejay/dist .
                git add -A
                git commit -m '[kernel buildbot] tvy: upload prebuilt to branch' --signoff
                git push -u origin prebuilt_bluejay_gki-ksunext
    
    pantah_gki:
        runs-on: ubuntu-22.04
        steps:
            - name: checkout scripts
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            
            - name: install packages
              run: |
                ./pkginstall

            - name: init credentials
              run: |   
                cd ~      
                git config --global user.name "[kernel buildbot] nhi"
                git config --global user.email "nhi@buildbot.tvyiutnhisokewt"
            
            - name: checkout aosp kernel build system
              run: |
                cp buildscript ~ 
                cd ~
                mkdir kernel
                cp buildscript kernel
                cd kernel
                repo init -u https://android.googlesource.com/kernel/manifest.git -b android-gs-pantah-6.1-android15-qpr2-beta --depth 1
                repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

            - name: checkout android14-6.1-lts
              run: |
                cd ~/kernel
                rm -rf aosp/
                git clone https://android.googlesource.com/kernel/common -b android14-6.1-lts --depth=1 aosp
  
            - name: build gki
              run: |
                cd ~
                BUILD_TYPE=gki ./kernel/buildscript pantah

            - name: upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                 name: pantah_gki
                 path: |
                    ~/kernel/out/pantah/dist/*
              
            - name: upload to branch
              run: |
                git checkout prebuilt_pantah_gki
                rm -rf *
                cp -rf ~/kernel/out/pantah/dist .
                git add -A
                git commit -m '[kernel buildbot] tnhi: upload prebuilt to branch' --signoff
                git push -u origin prebuilt_pantah_gki
          
    pantah_gki-ksunext:
        runs-on: ubuntu-22.04
        steps:
            - name: checkout scripts
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            
            - name: install packages
              run: |
                ./pkginstall

            - name: init credentials
              run: |   
                cd ~      
                git config --global user.name "[kernel buildbot] nhi"
                git config --global user.email "nhi@buildbot.tvyiutnhisokewt"
            
            - name: checkout aosp kernel build system
              run: |
                cp buildscript ~ 
                cd ~
                mkdir kernel
                cp buildscript kernel
                cd kernel
                repo init -u https://android.googlesource.com/kernel/manifest.git -b android-gs-pantah-6.1-android15-qpr2-beta --depth 1
                repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

            - name: checkout android14-6.1-lts
              run: |
                cd ~/kernel
                rm -rf aosp/
                git clone https://android.googlesource.com/kernel/common -b android14-6.1-lts --depth=1 aosp

            - name: clone wild kernel patches + susfs4ksu
              run: |
                git clone https://github.com/WildPlusKernel/kernel_patches.git
                git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1
                mv kernel_patches ~/kernel
                mv susfs4ksu ~/kernel

            - name: patch kernel ksunext susfs
              run: |
                cd ~
                cd kernel/aosp
                curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s next
                rm android/abi_gki_protected_exports_*
                cd ~/kernel
                cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ./aosp/
                cp susfs4ksu/kernel_patches/fs/* ./aosp/fs/
                cp susfs4ksu/kernel_patches/include/linux/* ./aosp/include/linux/
                cp kernel_patches/next/0001-kernel-patch-susfs-v1.5.5-to-KernelSU-Next-v1.0.5.patch ./aosp/KernelSU-Next
                cd ~/kernel/aosp/KernelSU-Next
                patch -p1 --forward < 0001-kernel-patch-susfs-v1.5.5-to-KernelSU-Next-v1.0.5.patch || true
                cd ..
                patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch || true
                
            - name: build gki with kernelsu-next
              run: |
                cd ~
                BUILD_TYPE=gki-ksunext ./kernel/buildscript pantah

            - name: upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                 name: pantah_gki-ksunext
                 path: |
                    ~/kernel/out/pantah/dist/*

            - name: upload to branch
              run: |
                git checkout prebuilt_pantah_gki-ksunext
                rm -rf *
                cp -rf ~/kernel/out/pantah/dist .
                git add -A
                git commit -m '[kernel buildbot] tnhi: upload prebuilt to branch' --signoff
                git push -u origin prebuilt_pantah_gki-ksunext
